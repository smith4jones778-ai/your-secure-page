<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>User Portal</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --brand:#2563eb;
  --bg:#f8fafc;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#64748b;
  --border:#e2e8f0;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,system-ui;
  background:linear-gradient(180deg,#eef2ff,#f8fafc);
  color:var(--text);
}

/* HEADER */
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:16px 28px;
  background:#fff;
  border-bottom:1px solid var(--border);
}
.logout{
  background:var(--brand);
  color:#fff;
  border:none;
  padding:8px 14px;
  border-radius:8px;
  cursor:pointer;
}

/* LAYOUT */
.wrap{max-width:1100px;margin:auto;padding:24px;}
.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
}

/* BUTTONS */
button.primary{
  background:var(--brand);
  color:#fff;
  border:none;
  padding:10px 16px;
  border-radius:10px;
  cursor:pointer;
}
button.ghost{
  background:none;
  border:1px solid var(--border);
  padding:8px 14px;
  border-radius:10px;
  cursor:pointer;
}

/* CARD */
.card{
  background:#fff;
  border:1px solid var(--border);
  border-radius:14px;
  padding:16px;
}

/* FILTERS */
.filters{
  display:flex;
  gap:10px;
  margin-bottom:12px;
}
.filters input,.filters select{
  padding:8px;
  border-radius:10px;
  border:1px solid var(--border);
}

/* INQUIRY */
.item{
  border:1px solid var(--border);
  border-radius:12px;
  padding:14px;
  margin-bottom:12px;
}
.badge{
  font-size:12px;
  padding:3px 10px;
  border-radius:20px;
}
.open{background:#fee2e2;color:#991b1b}
.answered{background:#dcfce7;color:#166534}

/* THREAD */
.thread{margin-top:10px}
.msg{
  padding:8px 10px;
  border-radius:10px;
  margin-bottom:6px;
  font-size:14px;
}
.user{background:#eef2ff}
.admin{background:#ecfeff}

/* REPLY */
.replybox{
  margin-top:8px;
}
.replybox textarea{
  height:70px;
}

/* MODAL */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  display:none;
  align-items:center;
  justify-content:center;
}
.modal.show{display:flex}
.modal-content{
  background:#fff;
  width:100%;
  max-width:500px;
  border-radius:14px;
  padding:18px;
}

/* FORM */
textarea,input{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid var(--border);
  font-family:inherit;
  margin-bottom:10px;
}
.empty{text-align:center;color:#64748b;padding:20px}
</style>
</head>

<body>

<div class="header">
  <b>Client Area</b>
  <button class="logout" onclick="logout()">Logout</button>
</div>

<div class="wrap">

  <div class="topbar">
    <h2 id="hello">Welcome ðŸ‘‹</h2>
    <button class="primary" onclick="openModal()">+ New Inquiry</button>
  </div>

  <div class="card">
    <h3>My Inquiries</h3>

    <div class="filters">
      <input id="search" placeholder="Search messages">
      <select id="status">
        <option value="">All</option>
        <option value="open">Open</option>
        <option value="answered">Answered</option>
      </select>
      <select id="sort">
        <option value="updated">Recently updated</option>
        <option value="created">Newest</option>
      </select>
    </div>

    <div id="list"></div>
  </div>

</div>

<!-- MODAL -->
<div id="modal" class="modal">
  <div class="modal-content">
    <h3>New Inquiry</h3>
    <textarea id="msg" placeholder="Describe your issue"></textarea>
    <button class="primary" onclick="send()">Send</button>
    <button class="ghost" onclick="closeModal()">Cancel</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyCl6RLrInQotd-GYmJ3VtA4wpAHfFltRUg",
  authDomain:"page-97b26.firebaseapp.com",
  projectId:"page-97b26"
});

const auth=firebase.auth();
const db=firebase.database();
const $=id=>document.getElementById(id);

let uid=null, all=[];

/* AUTH */
auth.onAuthStateChanged(async u=>{
  if(!u) return location="index.html";
  uid=u.uid;
  const name=(await db.ref("users/"+uid+"/name").once("value")).val();
  $("hello").innerText=`Welcome, ${name||"User"} ðŸ‘‹`;
  load();
});

/* LOAD */
function load(){
  db.ref("inquiries").on("value",s=>{
    all=[];
    s.forEach(c=>{
      const d=c.val();
      if(d.uid===uid) all.push({...d,id:c.key});
    });
    render();
  });
}

/* RENDER */
function render(){
  const q=$("search").value.toLowerCase();
  const st=$("status").value;
  const sort=$("sort").value;
  $("list").innerHTML="";

  let items = all.filter(i=>{
    const content=i.thread.map(m=>m.text).join(" ").toLowerCase();
    return (!q||content.includes(q)) && (!st||i.status===st);
  });

  items.sort((a,b)=>{
    return sort==="updated"
      ? (b.lastUpdated||b.createdAt)-(a.lastUpdated||a.createdAt)
      : b.createdAt-a.createdAt;
  });

  if(!items.length)
    return $("list").innerHTML='<div class="empty">No inquiries</div>';

  items.forEach(i=>{
    $("list").innerHTML+=`
      <div class="item">
        <div style="display:flex;justify-content:space-between">
          <b>Inquiry</b>
          <span class="badge ${i.status}">${i.status}</span>
        </div>

        <div class="thread">
          ${i.thread.map(m=>`
            <div class="msg ${m.from}">
              ${m.text}
              <div style="font-size:11px;color:#64748b">
                ${new Date(m.time).toLocaleString()}
              </div>
            </div>
          `).join("")}
        </div>

        <div class="replybox">
          <textarea id="reply-${i.id}" placeholder="Reply..."></textarea>
          <button class="ghost" onclick="reply('${i.id}')">Send reply</button>
        </div>
      </div>
    `;
  });
}

/* FILTER EVENTS */
search.oninput=render;
status.onchange=render;
sort.onchange=render;

/* NEW INQUIRY */
async function send(){
  const text=$("msg").value.trim();
  if(!text) return;

  await db.ref("inquiries").push({
    uid,
    status:"open",
    createdAt:Date.now(),
    lastUpdated:Date.now(),
    thread:[{
      from:"user",
      text,
      time:Date.now()
    }]
  });

  $("msg").value="";
  closeModal();
}

/* REPLY */
async function reply(id){
  const box=document.getElementById(`reply-${id}`);
  const text=box.value.trim();
  if(!text) return;

  const ref=db.ref("inquiries/"+id);
  const snap=await ref.once("value");
  const data=snap.val();

  data.thread.push({
    from:"user",
    text,
    time:Date.now()
  });

  await ref.update({
    thread:data.thread,
    status:"open",
    lastUpdated:Date.now()
  });

  box.value="";
}

/* MODAL */
const openModal=()=>modal.classList.add("show");
const closeModal=()=>modal.classList.remove("show");
const logout=()=>auth.signOut();
</script>

</body>
</html>
