<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Portal</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --brand:#2563eb;
  --bg:#f8fafc;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#64748b;
  --border:#e2e8f0;
  --success:#16a34a;
  --danger:#dc2626;
  --warn:#f59e0b;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,system-ui;
  background:linear-gradient(180deg,#eef2ff,#f8fafc);
  color:var(--text);
}

.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:16px 28px;
  background:#fff;
  border-bottom:1px solid var(--border);
}
.logout{
  background:var(--brand);
  color:#fff;
  border:none;
  padding:8px 14px;
  border-radius:8px;
  cursor:pointer;
}

.wrap{max-width:1200px;margin:auto;padding:24px;}
.card{
  background:#fff;
  border:1px solid var(--border);
  border-radius:14px;
  padding:16px;
  margin-bottom:16px;
}

.filters{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-bottom:12px;
}
.filters input,.filters select{
  padding:8px;
  border-radius:10px;
  border:1px solid var(--border);
}

.item{
  border:1px solid var(--border);
  border-radius:12px;
  padding:14px;
  margin-bottom:14px;
}
.badge{
  font-size:12px;
  padding:3px 10px;
  border-radius:20px;
}
.open{background:#fee2e2;color:#991b1b}
.answered{background:#dcfce7;color:#166534}
.closed{background:#e5e7eb;color:#374151}

.priority-high{color:var(--danger);font-weight:600}
.priority-normal{color:#2563eb}
.priority-low{color:var(--muted)}

.unread-dot{
  width:8px;height:8px;
  background:red;border-radius:50%;
  display:inline-block;margin-right:6px;
}

.thread{margin-top:10px}
.msg{
  padding:8px 10px;
  border-radius:10px;
  margin-bottom:6px;
  font-size:14px;
}
.user{background:#eef2ff}
.admin{background:#ecfeff}

textarea,input[type=file]{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid var(--border);
  font-family:inherit;
  margin-top:6px;
}
textarea{resize:none;height:80px}

button{
  border:none;
  padding:7px 12px;
  border-radius:8px;
  cursor:pointer;
}
.primary{background:var(--brand);color:white}
.warn{background:var(--warn);color:white}
.ghost{background:none;border:1px solid var(--border)}

.muted{color:var(--muted);font-size:13px}
</style>
</head>

<body>

<div class="header">
  <b>Administration</b>
  <button class="logout" onclick="auth.signOut()">Logout</button>
</div>

<div class="wrap">
  <h2 id="hello">Welcome ðŸ‘‹</h2>

  <div class="card">
    <h3>Inquiries</h3>

    <div class="filters">
      <input id="search" placeholder="Search messages">
      <select id="userFilter"><option value="">All users</option></select>
      <select id="statusFilter">
        <option value="">All status</option>
        <option value="open">Open</option>
        <option value="answered">Answered</option>
        <option value="closed">Closed</option>
      </select>
      <select id="priorityFilter">
        <option value="">All priority</option>
        <option value="high">High</option>
        <option value="normal">Normal</option>
        <option value="low">Low</option>
      </select>
    </div>

    <div id="list"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyCl6RLrInQotd-GYmJ3VtA4wpAHfFltRUg",
  authDomain:"page-97b26.firebaseapp.com",
  projectId:"page-97b26",
  storageBucket:"page-97b26.firebasestorage.app"
});

const auth=firebase.auth();
const db=firebase.database();
const storage=firebase.storage();
const $=id=>document.getElementById(id);

let all=[], users={}, limit=20;

/* AUTH */
auth.onAuthStateChanged(async u=>{
  if(!u) return location="index.html";
  const role=(await db.ref("users/"+u.uid+"/role").once("value")).val();
  if(role==="user") return location="user.html";
  const name=(await db.ref("users/"+u.uid+"/name").once("value")).val();
  $("hello").innerText=`Welcome, ${name||"Admin"} ðŸ‘‹`;
  loadUsers();
  loadInquiries();
});

/* USERS */
function loadUsers(){
  db.ref("users").on("value",s=>{
    users={};
    userFilter.innerHTML='<option value="">All users</option>';
    s.forEach(c=>{
      users[c.key]=c.val();
      userFilter.innerHTML+=`
        <option value="${c.key}">
          ${c.val().name||c.val().email}
        </option>`;
    });
  });
}

/* LOAD INQUIRIES */
function loadInquiries(){
  db.ref("inquiries").on("value",s=>{
    all=[];
    s.forEach(c=>{
      const d=c.val();
      const thread = Array.isArray(d.thread)
        ? d.thread
        : [{from:"user",text:d.message||"",time:d.createdAt||0}];

      all.push({
        id:c.key,
        uid:d.uid,
        status:d.status||"open",
        priority:d.priority||"normal",
        unread:d.unreadAdmin!==false,
        createdAt:d.createdAt||0,
        lastUpdated:d.lastUpdated||d.createdAt||0,
        thread
      });
    });
    render();
  });

  ["search","userFilter","statusFilter","priorityFilter"]
    .forEach(id=>$(id).oninput=render);
}

/* RENDER */
function render(){
  const q=search.value.toLowerCase();
  const u=userFilter.value;
  const st=statusFilter.value;
  const pr=priorityFilter.value;
  list.innerHTML="";

  all.filter(i=>{
    const content=i.thread.map(m=>m.text).join(" ").toLowerCase();
    return (!q||content.includes(q)) &&
           (!u||i.uid===u) &&
           (!st||i.status===st) &&
           (!pr||i.priority===pr);
  })
  .sort((a,b)=>b.lastUpdated-a.lastUpdated)
  .slice(0,limit)
  .forEach(i=>{
    list.innerHTML+=`
      <div class="item">
        ${i.unread?'<span class="unread-dot"></span>':''}
        <span class="badge ${i.status}">${i.status}</span>
        <span class="priority-${i.priority}">(${i.priority})</span>
        <div class="muted">
          User: ${users[i.uid]?.name||users[i.uid]?.email||i.uid}
        </div>

        <div class="thread">
          ${i.thread.map(m=>`
            <div class="msg ${m.from}">
              ${m.text}
              <div class="muted">${new Date(m.time).toLocaleString()}</div>
            </div>
          `).join("")}
        </div>

        <textarea id="r${i.id}" placeholder="Reply"></textarea>
        <input type="file" id="f${i.id}" multiple>

        <button class="primary" onclick="reply('${i.id}','${i.uid}')">Reply</button>
        <button class="warn" onclick="toggleStatus('${i.id}','${i.status}')">
          ${i.status==="closed"?"Reopen":"Close"}
        </button>
      </div>
    `;
  });
}

/* REPLY */
async function reply(id,uid){
  const box=$("r"+id);
  const files=$("f"+id).files;
  const text=box.value.trim();
  if(!text && !files.length) return;

  const snap=await db.ref("inquiries/"+id).once("value");
  const d=snap.val();
  const thread = Array.isArray(d.thread) ? d.thread : [];

  const uploaded=[];
  for(const f of files){
    const r=storage.ref(`admin/${id}/${Date.now()}_${f.name}`);
    await r.put(f);
    uploaded.push({name:f.name,url:await r.getDownloadURL()});
  }

  thread.push({from:"admin",text,files:uploaded,time:Date.now()});

  await db.ref("inquiries/"+id).update({
    thread,
    status:"answered",
    unreadAdmin:false,
    unreadUser:true,
    lastUpdated:Date.now()
  });

  db.ref("notifications/"+uid).push({
    text:"Admin replied to your inquiry",
    createdAt:Date.now()
  });

  box.value="";
}

/* STATUS */
function toggleStatus(id,s){
  db.ref("inquiries/"+id).update({
    status:s==="closed"?"open":"closed",
    lastUpdated:Date.now()
  });
}
</script>

</body>
</html>
