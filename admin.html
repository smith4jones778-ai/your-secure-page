<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Control</title>

<style>
body{font-family:Inter,Arial;margin:20px;max-width:1100px}
.top{display:flex;justify-content:space-between}
.card{border:1px solid #e5e5e5;border-radius:8px;padding:10px;margin:10px 0}
textarea,input,select,button{padding:8px;margin:5px 0}
textarea{width:100%;height:70px}
</style>
</head>
<body>

<div class="top">
<h2>Admin Dashboard</h2>
<button onclick="logout()">Logout</button>
</div>

<h3>Analytics</h3>
<div id="stats"></div>

<h3>Post Update</h3>
<textarea id="up"></textarea>
<button onclick="postUpdate()">Publish</button>

<h3>Upload File</h3>
<input type="file" id="file">
<button onclick="upload()">Upload</button>

<h3>Users</h3>
<div id="users"></div>

<h3>Inquiries</h3>
<div id="inq"></div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCl6RLrInQotd-GYmJ3VtA4wpAHfFltRUg",
  authDomain: "page-97b26.firebaseapp.com",
  projectId: "page-97b26",
  storageBucket: "page-97b26.firebasestorage.app",
  messagingSenderId: "268450715801",
  appId: "1:268450715801:web:33732e0f2fc2a69cfa0008"
};
firebase.initializeApp(firebaseConfig);

const auth=firebase.auth();
const db=firebase.database();
const storage=firebase.storage();

let myRole="";

auth.onAuthStateChanged(async u=>{
  if(!u) return location="index.html";

  myRole=(await db.ref("users/"+u.uid+"/role").once("value")).val();
  if(myRole==="user") location="user.html";

  loadStats();
  loadUsers();
  loadInq();
});

function logout(){auth.signOut();}

function loadStats(){
  db.ref("analytics").on("value",s=>{
    const d=s.val()||{};
    stats.innerHTML=`
      <div class="card">Users: ${d.usersCount||0}</div>
      <div class="card">Inquiries: ${d.inquiriesCount||0}</div>
    `;
  });
}

function postUpdate(){
  if(!up.value.trim()) return;
  db.ref("updates").push({text:up.value,createdAt:Date.now()});
  up.value="";
}

function upload(){
  const f=file.files[0];
  if(!f) return;

  const ref=storage.ref("files/"+Date.now()+"_"+f.name);
  ref.put(f).then(()=>ref.getDownloadURL()).then(url=>{
    db.ref("files").push({name:f.name,url,createdAt:Date.now()});
  });
}

function loadUsers(){
  db.ref("users").on("value",s=>{
    users.innerHTML="";
    s.forEach(c=>{
      const d=c.val();
      users.innerHTML+=`
      <div class="card">
        ${d.name||""} (${d.email}) 
        <br>Role:
        <select onchange="role('${c.key}',this.value)">
          <option ${d.role==="user"?"selected":""}>user</option>
          <option ${d.role==="admin"?"selected":""}>admin</option>
          <option ${d.role==="superadmin"?"selected":""}>superadmin</option>
        </select>
        ${myRole==="superadmin"?`<button onclick="delUser('${c.key}')">Delete</button>`:""}
        <button onclick="notify('${c.key}')">Notify</button>
      </div>`;
    });
  });
}

function role(uid,r){
  if(myRole!=="superadmin") return;
  db.ref("users/"+uid+"/role").set(r);
}

function delUser(uid){
  if(myRole!=="superadmin") return;

  db.ref("users/"+uid).remove();

  db.ref("inquiries").once("value",s=>{
    s.forEach(c=>{
      if(c.val().uid===uid) db.ref("inquiries/"+c.key).remove();
    });
  });
}

function notify(uid){
  const text=prompt("Message");
  if(!text) return;
  db.ref("notifications/"+uid).push({text,createdAt:Date.now()});
}

function loadInq(){
  db.ref("inquiries").on("value",s=>{
    inq.innerHTML="";
    s.forEach(c=>{
      const d=c.val();
      inq.innerHTML+=`
        <div class="card">
          ${d.message}
          <textarea id="r${c.key}">${d.response||""}</textarea>
          <button onclick="reply('${c.key}','${d.uid}')">Send</button>
        </div>`;
    });
  });
}

function reply(id,uid){
  const v=document.getElementById("r"+id).value;
  db.ref("inquiries/"+id).update({response:v,status:"answered"});
  db.ref("notifications/"+uid).push({text:"Your inquiry has a reply.",createdAt:Date.now()});
}
</script>

</body>
</html>
